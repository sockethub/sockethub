# syntax=docker.io/docker/dockerfile:1.7-labs

ARG bun_version=1.3.0
FROM oven/bun:${bun_version} AS base
WORKDIR /app

# -------------------------------------------------
# Stage 1: Install dependencies with aggressive optimizations
# -------------------------------------------------
FROM base AS deps
WORKDIR /app

# Install build tools
RUN apt-get update && apt-get install -y \
    python3 \
    make \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# Install node-gyp globally
RUN bun install -g node-gyp

# Copy full monorepo
COPY . ./

# Fast frozen install by skipping verification
RUN bun install --frozen-lockfile --no-verify

# -------------------------------------------------
# Stage 2: Build application
# -------------------------------------------------
FROM deps AS build
WORKDIR /app

RUN bun run build

# -------------------------------------------------
# Stage 3: Production runtime
# -------------------------------------------------
FROM base AS prod
WORKDIR /app

COPY --from=build /app ./

# Minimal production install
RUN bun install --production --frozen-lockfile --no-verify

CMD DEBUG=secure-store*,sockethub* /app/packages/sockethub/bin/sockethub --host 0.0.0.0
