name: Validate PR Branch and Title

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Validate branch name
        run: |
          BRANCH="${{ github.head_ref }}"
          
          # Allow release branches (created by automation)
          if [[ "$BRANCH" =~ ^release/v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            echo "✅ Release branch: $BRANCH"
            exit 0
          fi
          
          # Define valid prefixes
          VALID_PREFIXES=(
            "feat/"
            "fix/"
            "docs/"
            "style/"
            "refactor/"
            "perf/"
            "test/"
            "build/"
            "ci/"
            "chore/"
            "revert/"
          )
          
          # Check if branch starts with any valid prefix
          VALID=false
          for prefix in "${VALID_PREFIXES[@]}"; do
            if [[ "$BRANCH" == "$prefix"* ]]; then
              VALID=true
              echo "✅ Valid branch name: $BRANCH (prefix: $prefix)"
              break
            fi
          done
          
          if [ "$VALID" = false ]; then
            echo "❌ Invalid branch name: $BRANCH"
            echo ""
            echo "Branch names must start with one of these prefixes:"
            printf '  - %s\n' "${VALID_PREFIXES[@]}"
            echo ""
            echo "Examples:"
            echo "  - feat/add-reconnection-logic"
            echo "  - fix/handle-null-credentials"
            echo "  - docs/update-contributing-guide"
            echo "  - ci/automated-releases"
            echo ""
            echo "See docs/CONTRIBUTING.md for details"
            exit 1
          fi

      - name: Validate PR title
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          
          # Allow release PR titles (created by automation)
          if [[ "$TITLE" =~ ^chore\(release\):\ prepare\ v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            echo "✅ Release PR title: $TITLE"
            exit 0
          fi
          
          # Check conventional commit format: type(scope): description
          # or: type: description
          if [[ "$TITLE" =~ ^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?:\ .+ ]]; then
            echo "✅ Valid PR title: $TITLE"
            exit 0
          fi
          
          echo "❌ Invalid PR title: $TITLE"
          echo ""
          echo "PR titles must follow conventional commit format:"
          echo "  type(scope): description"
          echo "  or"
          echo "  type: description"
          echo ""
          echo "Valid types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert"
          echo ""
          echo "Examples:"
          echo "  - feat(irc): add reconnection logic"
          echo "  - fix: handle null credentials properly"
          echo "  - docs: update contributing guide"
          echo "  - ci: implement automated releases"
          echo ""
          echo "The PR title becomes the merge commit message and appears in the changelog."
          echo "See docs/CONTRIBUTING.md for details"
          exit 1
