name: Unpublish Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to unpublish (e.g., 5.0.0-alpha.5)'
        required: true
        type: string
      delete_release:
        description: 'Delete GitHub release'
        required: false
        type: boolean
        default: true
      delete_tag:
        description: 'Delete git tag'
        required: false
        type: boolean
        default: true
      unpublish_npm:
        description: 'Unpublish npm packages (only works within 72 hours)'
        required: false
        type: boolean
        default: false

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Validate version format
        run: |
          VERSION="${{ inputs.version }}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z]+\.[0-9]+)?$ ]]; then
            echo "‚ùå Invalid version format: $VERSION"
            echo "Expected format: X.Y.Z or X.Y.Z-prerelease.N"
            exit 1
          fi
          echo "‚úÖ Version format valid: $VERSION"

      - name: Check current state
        id: state
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ inputs.version }}"
          TAG="v$VERSION"

          echo "üîç Checking state for $TAG"
          echo ""

          # Check GitHub release
          RELEASE_EXISTS=$(gh release view "$TAG" --json tagName 2>/dev/null && echo "true" || echo "false")
          echo "release_exists=$RELEASE_EXISTS" >> $GITHUB_OUTPUT
          if [ "$RELEASE_EXISTS" = "true" ]; then
            echo "‚úÖ GitHub release exists: $TAG"
          else
            echo "‚ÑπÔ∏è No GitHub release found for $TAG"
          fi

          # Check git tag
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG$"; then
            echo "tag_exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Git tag exists: $TAG"
          else
            echo "tag_exists=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No git tag found for $TAG"
          fi

          echo ""

      - name: Check npm packages
        id: npm_check
        run: |
          VERSION="${{ inputs.version }}"
          echo "üîç Checking npm packages for version $VERSION"
          echo ""

          PUBLISHED_PACKAGES=""
          PACKAGES=$(find packages -maxdepth 2 -name "package.json" -not -path "*/node_modules/*")

          for pkg_json in $PACKAGES; do
            PKG_NAME=$(node -p "require('./$pkg_json').name")
            PKG_PRIVATE=$(node -p "require('./$pkg_json').private || false")

            if [ "$PKG_PRIVATE" = "true" ]; then
              continue
            fi

            NPM_VERSION=$(npm view "$PKG_NAME@$VERSION" version 2>/dev/null || echo "")
            if [ -n "$NPM_VERSION" ]; then
              echo "‚úÖ $PKG_NAME@$VERSION - published"
              PUBLISHED_PACKAGES="$PUBLISHED_PACKAGES $PKG_NAME"
            fi
          done

          if [ -z "$PUBLISHED_PACKAGES" ]; then
            echo ""
            echo "‚ÑπÔ∏è No packages published for version $VERSION"
            echo "has_published=false" >> $GITHUB_OUTPUT
          else
            echo ""
            echo "üì¶ Published packages:$PUBLISHED_PACKAGES"
            echo "has_published=true" >> $GITHUB_OUTPUT
            echo "packages=$PUBLISHED_PACKAGES" >> $GITHUB_OUTPUT
          fi

      - name: Delete GitHub release
        if: inputs.delete_release && steps.state.outputs.release_exists == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="v${{ inputs.version }}"
          echo "üóëÔ∏è Deleting GitHub release $TAG..."
          gh release delete "$TAG" --yes
          echo "‚úÖ Release deleted"

      - name: Delete git tag
        if: inputs.delete_tag && steps.state.outputs.tag_exists == 'true'
        run: |
          TAG="v${{ inputs.version }}"
          echo "üóëÔ∏è Deleting git tag $TAG..."
          git push origin --delete "$TAG"
          echo "‚úÖ Tag deleted"

      - name: Setup NPM authentication
        if: inputs.unpublish_npm && steps.npm_check.outputs.has_published == 'true'
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc

      - name: Unpublish npm packages
        if: inputs.unpublish_npm && steps.npm_check.outputs.has_published == 'true'
        run: |
          VERSION="${{ inputs.version }}"
          PACKAGES="${{ steps.npm_check.outputs.packages }}"

          echo "üóëÔ∏è Unpublishing npm packages..."
          echo ""
          echo "‚ö†Ô∏è Note: npm unpublish only works within 72 hours of publishing"
          echo ""

          FAILED=false
          for PKG in $PACKAGES; do
            echo "Unpublishing $PKG@$VERSION..."
            if npm unpublish "$PKG@$VERSION" 2>&1; then
              echo "‚úÖ $PKG@$VERSION unpublished"
            else
              echo "‚ùå Failed to unpublish $PKG@$VERSION (may be past 72 hour window)"
              FAILED=true
            fi
          done

          if [ "$FAILED" = "true" ]; then
            echo ""
            echo "‚ö†Ô∏è Some packages could not be unpublished"
            echo "This may be because they were published more than 72 hours ago"
            exit 1
          fi

      - name: Summary
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ inputs.version }}"
          TAG="v$VERSION"

          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üìã Unpublish Summary for $TAG"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""

          # Check final state
          if gh release view "$TAG" &>/dev/null; then
            echo "GitHub Release: ‚ö†Ô∏è Still exists"
          else
            echo "GitHub Release: ‚úÖ Deleted/Not found"
          fi

          if git ls-remote --tags origin | grep -q "refs/tags/$TAG$"; then
            echo "Git Tag: ‚ö†Ô∏è Still exists"
          else
            echo "Git Tag: ‚úÖ Deleted/Not found"
          fi

          echo ""
          echo "To verify npm packages, run locally:"
          echo "  ./scripts/verify-npm-publish.sh --version $VERSION"
