name: Auto Label PR

on:
  pull_request:
    types: [opened, reopened, edited, synchronize]

jobs:
  label:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    
    steps:
      - name: Auto-label based on PR title
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.pull_request.title;
            const labels = [];
            
            // Match conventional commit pattern: type(scope)!?: description
            const match = title.match(/^(\w+)(?:\(([^)]+)\))?(!)?:\s*/);
            
            if (match) {
              const [, type, scope, breaking] = match;
              
              // Add type label with type: prefix
              const typeLabel = `type:${type.toLowerCase()}`;
              labels.push(typeLabel);
              
              // If scope is present, validate it exists with scope: prefix
              if (scope) {
                const scopeLabel = `scope:${scope.toLowerCase()}`;
                
                // Check if scope label exists in repository
                try {
                  await github.rest.issues.getLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: scopeLabel
                  });
                  
                  // Label exists, add it
                  labels.push(scopeLabel);
                } catch (error) {
                  if (error.status === 404) {
                    core.setFailed(`âŒ Invalid scope in PR title: "${scopeLabel}" is not an existing label. Please use an existing scope label (e.g., platform-irc, data-layer) or update the PR title.`);
                    return;
                  }
                  throw error;
                }
              }
              
              // Special case: any type with ! adds breaking-change
              if (breaking === '!') {
                labels.push('breaking-change');
              }
            }
            
            if (labels.length > 0) {
              // Get existing labels
              const existingLabels = context.payload.pull_request.labels.map(l => l.name);
              
              // Only add labels that don't already exist
              const newLabels = labels.filter(l => !existingLabels.includes(l));
              
              if (newLabels.length > 0) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  labels: newLabels
                });
                
                core.info(`Added labels: ${newLabels.join(', ')}`);
              } else {
                core.info('All appropriate labels already exist');
              }
            } else {
              core.warning('No conventional commit prefix found in PR title');
            }
